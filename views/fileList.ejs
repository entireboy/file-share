<!DOCTYPE html>
<html>
  <head>
    <title><%= title.page %></title>
    <link rel='stylesheet' href='/css/style.css' />
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
    <style type="text/css">
      #more {display:none;}
      #no-more {display:none;}
      #more-error {display:none;}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row userInfo">
        <h2><%= title.fileList %> of <a href="/user/<%= user.id %>"><%= user.id %></a></h2>
      </div>
      <div class="row fileInfo">
        <div id="fileList" class="fileList<%= (file.hasMore)? ' hasMore' : '' %>">
          <% include fileContent %>
        </div>
        <div class="pager">
          <li class="previous">
            <a href="<%= page.path %>">first</a>
          </li>
          <% if(file.hasMore) { %>
            <li class="previous">
              <a href="<%= page.path %>?lastId=<%= file.lastId %>">more</a>
            </li>
          <% } %>
        </div>
        <div id="more">Loading more content</div>
        <div id="no-more">No more content</div>
        <div id="more-error">An error occurred while loading more content</div>
      </div>
    </div>

    <hr />
    <footer>
      <% include footer %>
    </footer>

    <!-- Placed at the end of the document so the pages load faster -->
    <!-- <script src="/js/bootstrap.min.js"></script> -->
    <script src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        var lastId = <%= file.lastId %>;
        var isLoadingContent = false;
        $(window).scroll(function () {
          if($(window).scrollTop() + $(window).height() > $(document).height() - 200) {
            $('#more-error').hide();
            if($('#fileList').hasClass('hasMore')) {
              $('#more').css('top', '400');
              $('#more').show();
            }
          } // end of if 페이지 끝에 닿기 200px 이내일 때
          if($(window).scrollTop() + $(window).height() == $(document).height()) {
            if($('#fileList').hasClass('hasMore') && !isLoadingContent) {
              $.ajax({
                type: 'GET'
                , datatype: 'json'
                , url: '<%= page.path %>.html?lastId=' + lastId
                , beforeSend: function(jqXHR, settings) {
                  isLoadingContent = true;
                }
              }).done(function(data, status, jqXHR) {
                $('#fileList').append(data.html);
                lastId = data.lastId;
                if(data.hasMore) $('#fileList').addClass('hasMore');
                else $('#fileList').removeClass('hasMore');
              }).fail(function(jqXHR, status, err) {
                $('#more-error').show();
              }).always(function() {
                $('#more').hide();
                isLoadingContent = false;
              });
            } else {
              $('#no-more').css('top', '400');
              $('#no-more').show();
            }
          } // end of if 페이지 끝에 닿았을 때
        }); // end of window.scroll event
      }); // end of document.ready event
    </script>
  </body>
</html>
